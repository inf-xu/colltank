# 收集罐 APP 功能描述

## 产品愿景
- 让用户以“类别 + 物品”的方式沉浸式记录收藏过程，保留图片与心情故事。
- 所有原始图片仅保存在本地目录，确保隐私与可控的文件结构。
- 通过画框拼贴、画框内容拖拽替换与下载分享，为每个类别营造仪式感。

## 核心使用流程
1. 在收集罐详细页面首次添加图片时请求目录访问权限，用户选择根目录；APP 在`/根目录/类别ID/图片ID`下写入文件。
2. 用户创建类别：填写类别名、描述、选择默认画框样式；系统生成 3×3 画布拼贴，即画框中画布可以存放9个物品图片。
3. 用户在类别下添加物品：选择照片（原图若不是正方形1:1，则APP提供裁剪为 1:1）、物品名字、时间、物语、心情 Icon、是否在画框展示。
4. 收集罐详细页面展示三段布局：画框拼贴 > 功能按钮 > 瀑布流图库。长按瀑布流图片可拖拽替换画框中任意格子。
5. 功能按钮：用户可切换画框样式或一键导出当前 3×3 拼贴，生成图片保存到本地。

## APP整体页面
该 APP 底部导航栏只有三个页面：`首页`、`日历`和`我的`。
每个页面的顶部导航栏样式都是标题在中间，`首页`页面会有一个顶部导航栏左侧有一个抽屉式的导航菜单（用于类别管理，后续类别管理详细介绍），`日历`页面和`我的`页面导航栏则无其他 Widget。

## 首页（收集罐页面）

### 首页样式
首页即收集罐页面，页面中心为可以左右滑动的滚轮卡片集合，页面中心只展示一个卡片，滑动切换不同卡片选中状态。滑到最后一个卡片是添加卡片。

### 类别卡片
卡片内容：类别名、描述、收集的物品数量、本年内收集物品的热力图
需要你合理的设计卡片样式展示内容

### 抽屉式的导航菜单（类别管理）
- 列表展示全部类别，使用Card实现，Card左边为类别名，右边为可拖拽的Icon。
- 长按类别Card可以拖拽。

### 添加卡片
卡片中心是一个"+"的Icon，点击图标按钮从页面底部弹出模态框，用于添加类别

## 收集罐详细页面
### 页面样式
收集罐详细页面分为三部分，第一部分为`画框画布`，第二部分为`功能按钮区`，第三部分为`瀑布流图库`。
以及浮动按钮上传图片。

### 功能描述
- 浮动按钮上传图片，提供裁剪为1:1（强制裁剪）；写入 Drift 数据库存储元数据，原图复制（默认为复制）到APP授权的指定目录。
- 属性字段：物品名、收藏时间、物语文本、心情图标（IconData及主题色）、是否参与画框展示、排序权重。

### 画框画布
- 画布为固定 3×3 方阵，画框支持多套内置样式（图片在`assets/frame/`，示例为：`assets/frame/photo_frame_xx.png`）。
- 长按瀑布流图片进入拖拽态，可放置到画布上任意格子，实时预览。
- 每个格子可点选快速更换或移除图片，保持 1:1 显示。
- 支持“随机打乱”，一次性重排当前画框中未锁定的图片位置。

### 功能按钮区
- 随机打乱：随机打乱画布中图片的顺序。
- 下载拼贴：合成当前画布（含画框 + 9 张图片），保存为本地 PNG；记录最后一次导出路径。

### 瀑布流图库
- GridView（瀑布流）展示类别下全部图片，惰性加载与缓存缩略图。
- 支持筛选（全部 / 画框展示中 / 未展示）、多选删除、进入详情查看属性。
- 详情页可编辑属性并更新数据库。

### 浮动按钮
- 点击上传图片，如果用户的图片不是正方形1:1，则需要进行剪裁为1:1形式。

## 日历（统计页面）
日历统计页面有两部分构成，上部分为日历视图，下部分为所选日期的分类别收藏物品列表。

## 页面描述
- 页面上部分为table_calendar的日历试图，可以切换周视图和月视图。
- 在日历视图中，如果某个日期中有上传物品图片的记录，则该日期有背景颜色。选中的日期为另一种颜色背景。
- 页面下部分展示选中日期当天的分类别收藏物品列表。按类别展示当前日期上传的图片信息（只展示名字、心情图标、物语），点击类别的归类图标，可以折叠当天该类别的图片上传记录，再次点击则展开。

## 我的页面（设置）
- 统计展示：统计面板和本年上传收藏物品的年度热力图。
- 统计面板包括：总统计（多少个收藏罐类别，一共多少张图片）。心情统计（每个心情类别的次数）。分类别统计（每个收藏罐类别的图片数量等等）。统计需要你分析然后补充。
- 

# 技术选型

## 三方库选择
- 状态管理：项目中所有的状态使用riverpod管理，flutter_riverpod和riverpod_annotation。
- 路由管理：项目中使用路由跳转使用go_router路由。
- 日历：项目中日历组件使用table_calendar库。
- 数据库：项目中表结构数据模型采用drift和drift_flutter存储。
- 数据模型：采用不可变数据模型freezed、freezed_annotation和json_annotation。
- 图标：项目中所有的IconData使用cupertino_icons图标库。
- 图表：项目中统计图表使用fl_chart，热力图使用fl_heatmap。

## 命令
- build_runner生成代码：flutter pub run build_runner build --delete-conflicting-outputs

## 体验与性能要点
- 将原图读写与缩略图生成放在后台 isolate，减少主线程卡顿。
- 使用 Riverpod 控制画框状态、瀑布流分页与拖拽高亮，避免整页重建。
- 画布区应用 RepaintBoundary，导出时抓取单一 widget，减少内存占用。
- Drift 数据缓存图片元数据，可配合 LazyQuery 只监听当前类别。
- 针对大图，提前生成裁剪缩略图，瀑布流加载本地缓存以节省 IO。

# 具体实现

## 2025-11-15 收集罐详情页图片上传
- 详情页新增 Riverpod 控制器，支持图库选取→1:1 裁剪→写入 Drift，并自动创建按收集罐 ID 分组的目录结构。
- 首次上传前需设置保存目录：提供底部指引弹窗与卡片按钮，调用系统目录选择器更新 `app_preferences.root_directory`。
- 遵循 Android 13+ 媒体权限，导入时会请求照片/存储权限，缺失时给出中文提示或引导前往系统设置。
- Android 11+ 同步申请 Manage External Storage，以便将裁剪后的图片写入用户自定义目录。
- 瀑布流区域改为真实数据源，图片缺失会提示“文件缺失”，无数据则展示占位说明。

## 2025-11-15 手动裁剪体验增强
- 浮动按钮上传图片流程新增手动裁剪页面，基于 `crop_your_image` 提供 1:1 可视化裁剪，支持拖动、缩放与重置区域。
- 原自动裁剪逻辑下线，所有图片均由用户确认后再落盘，避免被动裁剪导致内容缺失。

## 2025-11-15 画框导出到相册
- 详情页画布外层新增 `RepaintBoundary`，导出时捕获高分辨率 PNG，失败会给出友好提示。
- 集成 `gal` 插件，实现相册写入与权限申请，仅支持 Android 平台，保存到 “CollTank” 相册。
- 新增 `CollageExportService` 将“相册写入 + 导出日志”封装为单个事务，记录导出文件名、分辨率与大小。
- 导出按钮具备 Loading 状态，导出后使用 Snackbar 告知用户结果。

## 2025-11-15 画框拖拽替换
- 新增 `collectionHighlightSlotsProvider` 实时监听 3×3 槽位状态，并与 Drift 高亮表保持同步。
- 详情页画框区替换为 DragTarget 九宫格，空位提示拖拽指引，投放后调用 `AssignHighlightSlotUsecase` 自动写库。
- 瀑布流图片支持长按进入拖拽态，桌布展示图片缩略反馈，未设置或丢失文件会给出提示，方便用户定位问题。

## 2025-11-15 首页收集罐缩略图
- 首页滚轮卡片接入 `collectionHighlightSlotsProvider` 与 `collectibleDetailProvider`，实时渲染 3×3 画框略缩图，还原详情页的画框状态。
- 卡片内部按槽位逐项解析本地文件路径（支持绝对路径和根目录相对路径），无目录或文件缺失时展示中文提示占位。
- 原占位栅格升级为真实图片预览，但仍在数据缺失时回退，保障首页体验与性能。

## 2025-11-16 日历统计页面
- 新增 TableCalendar 周/月双视图，基于 Drift 聚合结果对有上传记录的日期背景着色，并在加载失败时提示状态。
- 通过新的 Riverpod Provider 监听指定日期的分类聚合，页面下半部分可以折叠/展开每个收集罐的当日上传条目，仅展示名称、心情与物语。
- 每个心情条目复用数据库中的 IconData 信息与色值，支持快速识别心情标签，并在空数据时提供中文占位引导。
